
@{
    ViewData["Title"] = "Calendar";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-8">
        <h2>Calendar</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("index", "Timesheets")">Timesheets</a>
            </li>
            <li class="breadcrumb-item">
                index
            </li>
            <li class="active breadcrumb-item">
                <strong>Time sheet</strong>
            </li>
        </ol>
    </div>
</div>
<div class="wrapper wrapper-content">
    <div class="row animated fadeInDown">
        <div class="col-lg-4">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>Enter Events</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li>
                                <a href="#" class="dropdown-item">Config option 1</a>
                            </li>
                            <li>
                                <a href="#" class="dropdown-item">Config option 2</a>
                            </li>
                        </ul>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id='external-events'>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="ibox ">
                                    <div class="ibox-content">
                                        <div class="hr-line-dashed"></div>
                                        <form role="form" id="form">

                                            <div class="form-grou row">
                                                <label class="col-sm-3 col-form-label">Job type</label>
                                                <div class="col-sm-9">
                                                    <select id="jobtype" class="selectjobtype select2_demo_3 form-control">
                                                        <option></option>
                                                        <option value="Bahamas">Bahamas</option>
                                                        <option value="Bahrain">Bahrain</option>
                                                        <option value="Bangladesh">Bangladesh</option>
                                                        <option value="Barbados">Barbados</option>
                                                        <option value="Belarus">Belarus</option>
                                                        <option value="Belgium">Belgium</option>
                                                        <option value="Belize">Belize</option>
                                                        <option value="Benin">Benin</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-grou row">
                                                <label class="col-sm-3 col-form-label">Project/Job</label>
                                                <div class="col-sm-9">
                                                    <select id="project" class="select2_demo_3 form-control">
                                                        <option></option>
                                                        <option value="Bahamas">Bahamas</option>
                                                        <option value="Bahrain">Bahrain</option>
                                                        <option value="Bangladesh">Bangladesh</option>
                                                        <option value="Barbados">Barbados</option>
                                                        <option value="Belarus">Belarus</option>
                                                        <option value="Belgium">Belgium</option>
                                                        <option value="Belize">Belize</option>
                                                        <option value="Benin">Benin</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed"></div>
                                            <div class="form-grou row">
                                                <label class="col-sm-3 col-form-label">Activities</label>
                                                <div class="col-sm-9">
                                                    <select id="activities" class="select2_demo_3 form-control">
                                                        <option></option>
                                                        <option value="Bahamas">Bahamas</option>
                                                        <option value="Bahrain">Bahrain</option>
                                                        <option value="Bangladesh">Bangladesh</option>
                                                        <option value="Barbados">Barbados</option>
                                                        <option value="Belarus">Belarus</option>
                                                        <option value="Belgium">Belgium</option>
                                                        <option value="Belize">Belize</option>
                                                        <option value="Benin">Benin</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed"></div>
                                            <div class="form-grou row">
                                                <label class="col-sm-3 col-form-label">Effort</label>
                                                <div class="col-sm-9">
                                                    <input type="number" id="effort" name="effort" class="form-control" data-mask="99.99" required />
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group" id="data_1">
                                                <label class="font-normal">Event Date</label>
                                                <div class="input-group date">
                                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" id="start" name="start" class="form-control">
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed"></div>
                                            <div class="form-grou row">
                                                <label class="col-sm-3 col-form-label">Remark</label>
                                                <div class="col-sm-9">
                                                    <textarea class="form-control" rows="5" id="comment"></textarea>
                                                </div>
                                            </div>



                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group row">
                                                <div class="col-sm-8 col-sm-offset-5">
                                                    <button class="btn btn-white btn-sm" id="showtoast" type="submit">Cancel</button>
                                                    <button class="btn btn-primary btn-sm" id="btnSave" type="submit">Save changes</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ibox ">
                <div class="ibox-content">
                    <h2>วิธีการลง Time sheet</h2>
                    ยังไม่รู้ว่าจะทำอย่างไรดีนะ เพราะว่ายังสรุปไม่ได้ว่าต้องเอาอะไรบ้าง
                    <p>
                        <a href="#" target="_blank">Time sheet documentation</a>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>Time Sheet</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li>
                                <a href="#" class="dropdown-item">Config option 1</a>
                            </li>
                            <li>
                                <a href="#" class="dropdown-item">Config option 2</a>
                            </li>
                        </ul>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--Toad notification -->
<div style="position: absolute; top: 20px; right: 20px;">

    <div class="toast toast2 toast-bootstrap" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fa fa-newspaper-o"> </i>
            <strong class="mr-auto m-l-sm">Notification</strong>
            <small>2 seconds ago</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body">
           <div id="divHtml"></div>
        </div>
    </div>
</div>




@section Styles {
    <environment names="Development,Staging,Production">
        <link rel="stylesheet" href="~/lib/iCheck/custom.css" />
        <link rel="stylesheet" href="~/lib/fullcalendar/fullcalendar.css" />
        <link rel="stylesheet" href="~/lib/iCheck/custom.css" />
        <link rel="stylesheet" href="~/lib/clockpicker/clockpicker.css" />
        <link rel="stylesheet" href="~/lib/daterangepicker/daterangepicker-bs3.css" />
        <link rel="stylesheet" href="~/lib/switchery/switchery.css" />
        <link rel="stylesheet" href="~/lib/ionRangeSlider/ion.rangeSlider.css" />
        <link rel="stylesheet" href="~/lib/colorpicker/bootstrap-colorpicker.min.css" />
        <link rel="stylesheet" href="~/lib/nouslider/jquery.nouislider.css" />
        <link rel="stylesheet" href="~/lib/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" />
        <link rel="stylesheet" href="~/lib/jasny-bootstrap/dist/css/jasny-bootstrap.css" />
        <link rel="stylesheet" href="~/lib/bootstrap-datepicker/dist/css/datepicker3.css" />
        <link rel="stylesheet" href="~/lib/cropper/dist/cropper.min.css" />
        <link rel="stylesheet" href="~/lib/select2/dist/css/select2.min.css" />
        <link rel="stylesheet" href="~/lib/select2/dist/css/select2-bootstrap4.min.css" />
        <link rel="stylesheet" href="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.css" />
        <link rel="stylesheet" href="~/lib/bootstrap-tagsinput/bootstrap-tagsinput.css" />
    </environment>
}

@section Scripts {
    <environment names="Development">
        <script src="~/lib/moment/moment.js"></script>
        <script src="~/lib/iCheck/icheck.min.js"></script>
        <script src="~/lib/fullcalendar/fullcalendar.min.js"></script>
        <script src="~/lib/jquery-ui/jquery-ui.js"></script>
        <script src="~/lib/iCheck/icheck.min.js"></script>
        <script src="~/lib/clockpicker/clockpicker.js"></script>
        <script src="~/lib/switchery/switchery.js"></script>
        <script src="~/lib/daterangepicker/daterangepicker.js"></script>
        <script src="~/lib/ionRangeSlider/ion.rangeSlider.min.js"></script>
        <script src="~/lib/colorpicker/bootstrap-colorpicker.min.js"></script>
        <script src="~/lib/nouslider/jquery.nouislider.min.js"></script>
        <script src="~/lib/jasny-bootstrap/dist/js/jasny-bootstrap.min.js"></script>
        <script src="~/lib/bootstrap-datepicker/dist/js/bootstrap-datepicker.js"></script>
        <script src="~/lib/jknob/dist/jquery.knob.min.js"></script>
        <script src="~/lib/cropper/dist/cropper.min.js"></script>
        <script src="~/lib/select2/dist/js/select2.full.min.js"></script>
        <script src="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>
        <script src="~/lib/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>
        <script src="~/lib/dualListbox/jquery.bootstrap-duallistbox.js"></script>

    </environment>
    <environment names="Staging,Production">
        <script src="~/lib/moment/min/moment.min.js"></script>
        <script src="~/lib/iCheck/icheck.min.js"></script>
        <script src="~/lib/fullcalendar/fullcalendar.min.js"></script>
        <script src="~/lib/jquery-ui/jquery-ui.js"></script>
        <script src="~/lib/iCheck/icheck.min.js"></script>
        <script src="~/lib/clockpicker/clockpicker.js"></script>
        <script src="~/lib/switchery/switchery.js"></script>
        <script src="~/lib/daterangepicker/daterangepicker.js"></script>
        <script src="~/lib/ionRangeSlider/ion.rangeSlider.min.js"></script>
        <script src="~/lib/colorpicker/bootstrap-colorpicker.min.js"></script>
        <script src="~/lib/nouslider/jquery.nouislider.min.js"></script>
        <script src="~/lib/jasny-bootstrap/dist/js/jasny-bootstrap.min.js"></script>
        <script src="~/lib/bootstrap-datepicker/dist/js/bootstrap-datepicker.js"></script>
        <script src="~/lib/jknob/dist/jquery.knob.min.js"></script>
        <script src="~/lib/cropper/dist/cropper.min.js"></script>
        <script src="~/lib/select2/dist/js/select2.full.min.js"></script>
        <script src="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>
        <script src="~/lib/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>
        <script src="~/lib/dualListbox/jquery.bootstrap-duallistbox.js"></script>
    </environment>

    <script type="text/javascript">
    $(document).ready(function () {

        //Toad notification intail //

        let toast1 = $('.toast1');
        let toast2 = $('.toast2');

        toast1.toast({
            delay: 3000,
            animation: true
        });
        toast2.toast({
            delay: 3000,
            animation: true
        });



        poppulateDropDown();
        sessionStorage.setItem("Id", 0);
        $('#data_1 .input-group.date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            calendarWeeks: true,
            autoclose: true,
            format: 'dd/mm/yyyy',
            toDate: true

        }).datepicker('setDate', new Date());




        FetchEventAndRenderCalendar();

        $("#btnSave").click(function () {
            var fullDate = new Date();
            var twoDigitMonth = fullDate.getMonth() + ""; if (twoDigitMonth.length == 1) twoDigitMonth = "0" + twoDigitMonth;
            var twoDigitDate = fullDate.getDate() + ""; if (twoDigitDate.length == 1) twoDigitDate = "0" + twoDigitDate;
            var currentDate = twoDigitDate + "/" + twoDigitMonth + "/" + fullDate.getFullYear(); console.log(currentDate);
            var id = sessionStorage.getItem("Id");
            var tmpDate = $("#start").val();
            var startTime = tmpDate + ' 7:59';
            startTime = startTime.match(/(\d+)\/(\d+)\/(\d+)\s*(\d+):(\d+)/);
            startTime = new Date(startTime[3], startTime[2] - 1, startTime[1], startTime[4], startTime[5], 0, 0);
            //var i = new Date(2019, 12, 2, 0, 0, 0, 0);
            //alert(moment(startTime));
            var realtime = moment(startTime);
            var param = {
                Id: parseInt(id),
                JobTypeId: parseInt($("#jobtype :selected").val()),
                ProjectId: parseInt($("#project :selected").val()),
                ActivitiesId: parseInt($("#activities :selected").val()),
                Effort: parseFloat($("#effort").val()),
                Remark: $("#comment").val(),
                StartDate: realtime,
                EndDate: realtime,
                CrtUser: "Banphotkho",
                CrtDate: fullDate
            }
            alert('finish');
            $.ajax({
                type: "POST",
                url: '@Url.Action("SaveTimesheet", "Timesheets")',
                contentType: 'application/json; charset=utf-8',
                dataType: "json",
                data: JSON.stringify(param),
                success: function (data) {

                    FetchEventAndRenderCalendar(); //Call Refresh Calendar//

                    // Clear All text on input screen//
                    $("#comment").val("");
                    $("#jobtype").val("");
                    $("#project").val("");
                    $("#jobtype").val("");
                    $("#activities").val("");
                    $("#effort").val("");
                    $("#start").val("");
                    sessionStorage.setItem("Id", 0);

                    $('#data_1 .input-group.date').datepicker({
                        todayBtn: "linked",
                        keyboardNavigation: false,
                        forceParse: false,
                        calendarWeeks: true,
                        autoclose: true,
                        format: 'dd/mm/yyyy',
                        toDate: true

                    }).datepicker('setDate', new Date());

                    $("#divHtml").html("Update calendar has finish!");
                    toast2.toast('show');

                },
                error: function (data) {
                    $(this).find(".toast-body").text("Add data to database Fail!");
                    toast1.toast('show');
                }


            });

            return false;
        });


        //$('.i-checks').iCheck({
        //    checkboxClass: 'icheckbox_square-green',
        //    radioClass: 'iradio_square-green',
        //});

        ///* initialize the external events
        // -----------------------------------------------------------------*/


        //$('#external-events div.external-event').each(function () {

        //    // store data so the calendar knows to render an event upon drop
        //    $(this).data('event', {
        //        title: $.trim($(this).text()), // use the element's text as the event title
        //        stick: true // maintain when user navigates (see docs on the renderEvent method)
        //    });

        //    // make the event draggable using jQuery UI
        //    $(this).draggable({
        //        zIndex: 1111999,
        //        revert: true,      // will cause the event to go back to its
        //        revertDuration: 0  //  original position after the drag
        //    });

        //});

        //propulate data to project

        $("select.selectjobtype").change(function () {
            var jobtype = $(this).children("option:selected").val();

            var param = {
                id: parseInt(jobtype)
            }

            $.ajax({
                type: "POST",
                contentType: 'application/json; charset=utf-8',
                url: '@Url.Action("getProjectDetail","timesheets")',
                dataType: 'json',
                data: JSON.stringify(param),
                success: function (data) {
                    var items = '';
                    $('#project').empty();
                    $('#project ').append('<option></option>');
                    $.each(data, function (i, item) {
                        $('#project').append('<option value="' + item.id + '">' + item.descriptions + '</option>');
                    });
                },
                error: function (ex) {
                    var r = jQuery.parseJSON(response.responseText);
                    alert("Message: " + r.Message);
                    alert("StackTrace: " + r.StackTrace);
                    alert("ExceptionType: " + r.ExceptionType);
                }
            });


        });



        function toDate(dateStr) {
            var parts = dateStr.split("/");
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function poppulateDropDown() {
            // jobtype
            $.ajax({
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                url: '@Url.Action("getProjectType","timesheets")',
                dataType: 'json',
                data: {},
                success: function (data) {
                    var items = '';
                    $('#jobtype').empty();
                    $('#jobtype ').append('<option></option>');
                    $.each(data, function (i, item) {
                        $('#jobtype').append('<option value="' + item.id + '">' + item.descriptions + '</option>');
                    });
                },
                error: function (ex) {
                    var r = jQuery.parseJSON(response.responseText);
                    alert("Message: " + r.Message);
                    alert("StackTrace: " + r.StackTrace);
                    alert("ExceptionType: " + r.ExceptionType);
                }
            });

            $.ajax({
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                url: '@Url.Action("getActivities","timesheets")',
                dataType: 'json',
                data: {},
                success: function (data) {
                    var items = '';
                    $('#activities').empty();
                    $('#activities').append('<option></option>');
                    $.each(data, function (i, item) {
                        $('#activities').append('<option value="' + item.id + '">' + item.activityName + '</option>');
                    });
                },
                error: function (ex) {
                    var r = jQuery.parseJSON(response.responseText);
                    alert("Message: " + r.Message);
                    alert("StackTrace: " + r.StackTrace);
                    alert("ExceptionType: " + r.ExceptionType);
                }
            });

            $('#project').empty();


        }

        function GenerateCalender(events) {
            $('#calendar').fullCalendar('destroy');
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek'
                },
                editable: true,
                droppable: true, // this allows things to be dropped onto the calendar
                drop: function () {
                    // is the "remove after drop" checkbox checked?
                    if ($('#drop-remove').is(':checked')) {
                        // if so, remove the element from the "Draggable Events" list
                        $(this).remove();
                    }
                },
                events: events,
                eventClick: function (calEvent, jsEvent, view) {
                    selectedEvent = calEvent;
                    alert(calEvent.title);
                }
            })
        }

        function FetchEventAndRenderCalendar() {
            events = [];
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetEvents","timesheets")',
                success: function (data) {

                    $.each(data, function (i, v) {
                        events.push({
                            eventID: v.eventId,
                            title: v.projectName,
                            description: v.Description,
                            start: moment(v.dateStart)
                        });
                    })
                    GenerateCalender(events);
                },
                error: function (error) {
                    alert('failed');
                }
            })
        }


        /* initialize the calendar
         -----------------------------------------------------------------*/


        //var date = new Date();
        //var d = date.getDate();
        //var m = date.getMonth();
        //var y = date.getFullYear();

        //$('#calendar').fullCalendar({
        //    header: {
        //        left: 'prev,next today',
        //        center: 'title',
        //        right: 'month,agendaWeek'
        //    },
        //    editable: true,
        //    droppable: true, // this allows things to be dropped onto the calendar
        //    drop: function () {
        //        // is the "remove after drop" checkbox checked?
        //        if ($('#drop-remove').is(':checked')) {
        //            // if so, remove the element from the "Draggable Events" list
        //            $(this).remove();
        //        }
        //    },
        //    events: [
        //        {
        //            title: 'All Day Event',
        //            start: new Date(y, m, 1)
        //        },
        //        {
        //            title: 'Long Event',
        //            start: new Date(y, m, d - 5),
        //            end: new Date(y, m, d - 2),
        //        },
        //        {
        //            id: 999,
        //            title: 'Repeating Event',
        //            start: new Date(y, m, d - 3, 16, 0),
        //            allDay: false,
        //        },
        //        {
        //            id: 999,
        //            title: 'Repeating Event',
        //            start: new Date(y, m, d + 4, 16, 0),
        //            allDay: false
        //        },
        //        {
        //            title: 'Meeting',
        //            start: new Date(y, m, d, 10, 30),
        //            allDay: false
        //        },
        //        {
        //            title: 'Lunch',
        //            start: new Date(y, m, d, 12, 0),
        //            end: new Date(y, m, d, 14, 0),
        //            allDay: false
        //        },
        //        {
        //            title: 'Birthday Party',
        //            start: new Date(y, m, d + 1, 19, 0),
        //            end: new Date(y, m, d + 1, 22, 30),
        //            allDay: false
        //        },
        //        {
        //            title: 'Click for Google',
        //            start: new Date(y, m, 28),
        //            end: new Date(y, m, 29),
        //            url: 'http://google.com/'
        //        }
        //    ],
        //});


    });</script>
}

